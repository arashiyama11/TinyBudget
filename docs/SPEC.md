### **仕様書**

#### 1. 概要

* **目的:** 特定のアプリ起動をトリガーに、オーバーレイで支出を記録できる家計簿アプリ。
* **対象ユーザー:** 手軽に支出を記録したいユーザー。
* **主要機能:**
    * オーバーレイによる支出記録
    * 月別の支出履歴の表示
    * カテゴリ別の支出集計
    * 支出の修正・削除

#### 2. 機能仕様

##### 2.1. 支出記録 (オーバーレイ)

* **トリガー:** ユーザーが設定したアプリがフォアグラウンドで起動した時。
* **UI:**
    * 画面右側中央を初期位置としてオーバーレイを表示する。
    * オーバーレイはドラッグ＆ドロップで移動可能。
    * オーバーレイは右下をドラッグしてリサイズ可能。
    * 入力項目:
        * 金額 (数値入力)
        * カテゴリ (「食費」「その他」から選択)
        * メモ (任意入力)
    * アクション:
        * **保存ボタン:** 入力内容を保存し、オーバーレイは閉じない。
* **挙動:**
    * オーバーレイ表示中に他のアプリに切り替えても、オーバーレイは表示されたままにする。

##### 2.2. 支出履歴 (アプリ本体)

* **表示:**
    * 月別に支出を一覧表示する。
    * 各月の総支出額を表示する。
    * 各月のカテゴリ別（食費/その他）の支出額を表示する。
* **アクション:**
    * **修正:** 履歴一覧の各項目をタップすると、編集画面に遷移し、金額・カテゴリ・メモを修正できる。
    * **削除:** 履歴一覧の各項目を長押し、またはスワイプで削除確認ダイアログを表示し、承認すると削除する。

##### 2.3. 設定

* **トリガーアプリ設定:** オーバーレイを起動する対象のアプリを複数選択できる。
* **カテゴリ管理:**
    * カテゴリのON/OFF切り替え機能。
    * ユーザーによるカテゴリの追加・編集・削除機能。
* **権限設定:**
    * オーバーレイ表示 (`SYSTEM_ALERT_WINDOW`) とアクセシビリティサービス (
      `BIND_ACCESSIBILITY_SERVICE`) の権限が許可されていない場合、設定画面へ誘導する。

#### 3. 技術仕様

##### 3.1. データモデル (Room)

* **Transaction (取引) Entity:**
    * `id`: `Int` (主キー, 自動生成)
    * `amount`: `Long` (金額)
    * `categoryId`: `Int` (カテゴリID)
    * `note`: `String` (メモ)
    * `timestamp`: `Long` (記録日時)
* **Category (カテゴリ) Entity:**
    * `id`: `Int` (主キー, 自動生成)
    * `name`: `String` (カテゴリ名)
* **DAO (Data Access Object):**
    * `TransactionDao`: 取引データのCRUD操作。
    * `CategoryDao`: カテゴリデータのCRUD操作。

##### 3.2. アクセシビリティサービス

* **トリガー:** `TYPE_WINDOW_STATE_CHANGED` イベントを監視。
* **動作:**
    1. フォアグラウンドのアプリのパッケージ名を取得する。
    2. ユーザーが設定した対象アプリのパッケージ名と一致するか判定する。
    3. 一致した場合、オーバーレイ表示用の`Service`を起動する。

##### 3.3. オーバーレイ表示

* **実装:** `Service`と`WindowManager`を使用。
* **UI:** Jetpack Composeで作成。
* **機能:**
    * 金額・カテゴリ・メモの入力。
    * 保存・閉じるアクション。
    * ドラッグによる移動。
    * ドラッグによるリサイズ。

#### 4. 権限

* `android.permission.SYSTEM_ALERT_WINDOW`
* `android.permission.BIND_ACCESSIBILITY_SERVICE`